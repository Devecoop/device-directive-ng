/* device-component-ng - v0.2.0-beta - 2014-06-04 */
"use strict";angular.module("lelylan.directives.device",["lelylan.client","lelylan.directives.device.services.properties","lelylan.directives.device.services.functions","lelylan.directives.device.services.statuses","lelylan.directives.device.services.utils","lelylan.directives.device.directive","ngTouch","ngAnimate","angularMoment"]),angular.module("lelylan.directives.device.directive",[]),angular.module("lelylan.directives.device.directive").directive("device",["$rootScope","$timeout","$compile","$templateCache","$http","Profile","Device","Type","DeviceProperties","DeviceFunction","DeviceStatuses",function(a,b,c,d,e,f,g,h,i,j,k){var l={restrict:"EA",replace:!0,scope:{deviceId:"@",deviceJson:"@",deviceTemplate:"@"}};return l.link=function(l,m,n){l.view={path:"/loading"},l.template=n.deviceTemplate||"bower_components/device-component-ng/dist/views/templates/default.html",l.hasStatuses=!0,l.hasFunctions=!0;var o=function(){e.get(l.template,{cache:d}).success(function(a){m.html(a),c(m.contents())(l)})};o(),l.$watch("deviceId",function(a){a&&g.find(a).success(function(a){l.device=a,p(a.type.id)}).error(function(){l.view.path="/message",l.message={title:"Unauthorized Access",description:"You have not the rights to access this device"}})}),l.$watch("deviceJson",function(a){a&&(a=JSON.parse(a),l.device=a,p(a.type.id))});var p=function(a){h.find(a).success(function(a){l.type=a,q()})},q=function(){l.visualization(),l.initialize(),l.view.path="/default"};l.initialize=function(){i.extend(l),j.setForms(l),k.set(l),l.animateStatus()},l.visualization=function(){l.hasStatuses=0!=l.type.statuses.length,l.hasFunctions=0!=l.type.functions.length},l.showDefault=function(){l.view.path="/default"},l.showSettings=function(){l.deviceCopy=angular.copy(l.device),l.view.path="/settings",l.privates||r(l.device.id)};var r=function(a){l.isMaker()&&g.privates(a).success(function(a){l.privates=a}).error(function(){l.view.path="/message",l.message={title:"Unauthorized Access",description:"You have not the rights to access this device"}})};l.isMaker=function(){return f.get()&&f.get().id==l.device.maker.id},l.execute=function(a){j.execute(a)},l.updateProperties=function(a){i.update(l,a,m),l.initialize()},l.update=function(){l.view.path="/default",g.update(l.device.id,l.device).success(function(b){l.device=b,a.$broadcast("lelylan:device:update",b)})},l.destroy=function(b){b==l.device.name&&(l.view.path="/message",l.message={title:"Device deleted",description:"Reload the page to update the view"},g.delete(l.device.id).success(function(b){l.device=b,a.$broadcast("lelylan:device:delete",b)}))},l.resetForm=function(){l.device.name=l.deviceCopy.name,l.device.physical.uri=l.device.physical.uri},l.animateStatus=function(){var a="flipInX";m.find(".ly-updated-animation").addClass("animated "+a),b(function(){m.find(".ly-updated-animation").removeClass("animated "+a)},500)},l.fire=function(b){a.$broadcast("lelylan:device:custom:"+b,l.device)},l.$on("lelylan:device:template:update",function(a,b){b.id&&b.id!=l.device.id||(l.template=b.template,o(l))})},l}]);var client=angular.module("lelylan.directives.device.services.functions",[]);client.factory("DeviceFunction",["Utils",function(a){var b,c={};return c.setForms=function(a){b=a,a.functions=angular.copy(a.type.functions),_.each(a.functions,function(b){c.setForm(b,a)})},c.execute=function(a){a&&(0==a.toFill?b.updateProperties(a.properties):(1==a.visibleForm&&b.updateProperties(a.properties),a.visibleForm=!a.visibleForm))},c.setForm=function(a,b){c.setPropertiesToFill(a),c.setFunctionToFill(a),c.setExpectedProperties(a,b),c.extendFunctionProperties(a,b),c.setNumberValuesToInt(a,b)},c.setPropertiesToFill=function(a){_.each(a.properties,function(a){a.toFill=null==a.expected})},c.setFunctionToFill=function(a){a.toFill=_.reduce(a.properties,function(a,b){return a||b.toFill},!1)},c.setExpectedProperties=function(b,c){_.each(b.properties,function(b){b.toFill&&(b.expected=a.getResource(b.id,c.device.properties).expected)})},c.extendFunctionProperties=function(b,c){_.each(b.properties,function(b){var d=a.getResource(b.id,c.type.properties);b.name=d.name,b.type=d.type,b.range=d.range,b.accepted=d.accepted})},c.setNumberValuesToInt=function(a){_.each(a.properties,function(a){"number"==a.type&&(a.expected=parseFloat(a.expected))})},c}]);var client=angular.module("lelylan.directives.device.services.properties",[]);client.factory("DeviceProperties",["$rootScope","Device","Utils",function(a,b,c){var d={};return d.update=function(a,b){var c=d.mapProperties(b);d.sendProperties(a,c),d.optimisticProperties(a,c),a.device.pending=!0},d.extend=function(a){_.each(a.device.properties,function(b){var d=c.getResource(b.id,a.type.properties);b.name=d.name,b.type=d.type})},d.mapProperties=function(a){return _.map(a,function(a){return{id:a.id,pending:a.pending,expected:a.expected}})},d.sendProperties=function(c,e){a.$broadcast("lelylan:device:function:start",c.device),b.properties(c.device.id,{properties:e}).success(function(b){c.device=b,d.extend(c),a.$broadcast("lelylan:device:function:end",c.device)})},d.optimisticProperties=function(a,b){_.each(b,function(b){var d=c.getResource(b.id,a.device.properties);a.device.updated_at=new Date,d.pending=!0,d.expected=b.expected,d.value=b.expected})},d}]);var client=angular.module("lelylan.directives.device.services.statuses",[]);client.factory("DeviceStatuses",["Utils",function(a){var b={};return b.set=function(c){c.status=status,_.each(c.type.statuses,function(d){b.checkStatus(d,c.device)&&(c.status=d,c.status.function=a.getResource(d.function.id,c.functions))})},b.checkStatus=function(c,d){var e=[];return _.each(c.properties,function(c){var f=a.getResource(c.id,d.properties);e.push(b.passProperty(f,c))}),_.every(e,_.identity)},b.passProperty=function(a,c){var d=!0;return d=d&&b.checkPending(a,c),d=d&&b.checkValues(a,c),d=d&&b.checkRanges(a,c)},b.checkPending=function(a,b){return b.pending?b.pending==a.pending?!0:!1:!0},b.checkValues=function(a,b){return 0==b.values.length?!0:_.contains(b.values,a.value)?!0:!1},b.checkRanges=function(a,b){if(0==b.ranges.length)return!0;var c=!1;return _.each(b.ranges,function(b){var d=parseInt(a.value);c=c||d>=b.min&&d<=b.max}),c},b}]);var client=angular.module("lelylan.directives.device.services.utils",[]);client.factory("Utils",function(){var a={};return a.getResource=function(a,b){return _.find(b,function(b){return b.id==a})},a});var app=angular.module("app",["lelylan.directives.device","ngMockE2E"]);app.run(function(a,b,c){c.set({id:"1"}),jasmine.getFixtures().fixturesPath="spec/fixtures",device=JSON.parse(readFixtures("device.json")),type=JSON.parse(readFixtures("type.json")),privates=JSON.parse(readFixtures("privates.json")),a.when("GET",/\/templates\//).passThrough(),a.whenGET("http://api.lelylan.com/devices/1").respond(device),a.whenPUT("http://api.lelylan.com/devices/1").respond(function(a,b,c){return[200,d(c),{}]}),a.whenPUT("http://api.lelylan.com/devices/1/properties").respond(function(a,b,c){return[200,e(c),{}]}),a.whenDELETE("http://api.lelylan.com/devices/1").respond(device),a.whenGET("http://api.lelylan.com/types/1").respond(type),a.whenGET("http://api.lelylan.com/devices/1/privates").respond(privates);var d=function(a){return a=angular.fromJson(a),device.updated_at=new Date,device.name=a.name,device.physical.uri=a.physical.uri,device},e=function(a){return a=angular.fromJson(a),device.updated_at=new Date,_.each(a.properties,function(a){var b=_.find(device.properties,function(b){return b.id==a.id});b.expected=b.value=a.expected}),device}}),app.config(function(a){a.decorator("$httpBackend",function(a){var b=function(b,c,d,e,f){var g=function(){var a=this,b=arguments;setTimeout(function(){e.apply(a,b)},1e3)};return a.call(this,b,c,d,g,f)};for(var c in a)b[c]=a[c];return b})});